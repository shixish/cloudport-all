{% extends "base.html" %}
{% load verbatim %}

{% block title %}Manager{% endblock %}

{% block head %}
	{% verbatim %}
	<script id="job-row" type="text/x-handlebars-template">
		<strong>{{title}}</strong>
		<span class="controls">
		{{#if stopped}}
			<a href="#" class="restart warning button">Restart</a>
		{{else}}
			{{#if done}}
				<a href="/jobs_finished/{{output}}" class="view line button">View Results</a>
			{{else}}
				<!--<a href="#pause={{id}}" class="pause warning button">Pause</a>-->
				<a href="#stop={{id}}" class="stop delete button">Stop</a>
			{{/if}}
		{{/if}}
		</span>
	</script>
	<script id="job-rows" type="text/x-handlebars-template">
		{{#list things}}
			<strong>{{title}}</strong>
			<span class="controls">
				<a href="#pause={{id}}" class="pause warning button">Pause</a>
				<a href="#stop={{id}}" class="stop delete button">Stop</a>
			</span>
		{{/list}}
	</script>
	{% endverbatim %}
	<script type="text/javascript">
		$(function(){
			/*var Workspace = Backbone.Router.extend({
				routes: {
					"help":								 "help",		// #help
					"search/:query":				"search",	// #search/kiwis
					"search/:query/p:page": "search"	 // #search/kiwis/p7
				},
				help: function() {
				console.log("Help Fired!");
				},
				search: function(query, page) {
					console.log("Searching for: " + query + " on page " + page);
				}
			});
			var ws = new Workspace;
			ws.bind("route:help", function(){
				console.log("Help Fired! 2");
			});
			Backbone.history.start();
			*/
			
			var Job = Backbone.Model.extend({
				initialize: function(e){
					//console.log('init', e);
					this.bind('change:status',	 this.changeStatus, this);
					//this.set({'status':1});
					this.changeStatus();
				},
				changeStatus:function(e){
					//assume a running state
					var stopped = false, done = false;
					switch(this.get('status')){
						case 0: break;//Running state
						case 1: done = true; break;//Done state
						case 2: stopped = true; break; //Error state
					}
					this.set({'stopped':stopped, 'done':done});
				}
				/*defaults: function(){
					return {
						"id":0,
						"done": false,
						"name":""
					}
				},*/
			});
			
			JobList = Backbone.Collection.extend({
				model: Job,
				url: '/rest/job/?_accept=application/json',
				//url: '/manager/get/jobs',
				test:function(){
					return this.filter(function(it){
						console.log(it);
					});
				}
			});
			
			var JobView = Backbone.View.extend({
				tagName: "li",
				
				template: Handlebars.compile($('#job-row').html()),
				
				events: {
					"click .view":		"view",
					"click .pause":		"pause",
					"click .stop":		"stop",
					"click .restart":	"restart",
				},
				
				view: function(){
					//alert('view');
					var img_url = 
					$('#app #img').html('<img src="/jobs_finished/'+this.model.get('output')+'" \>');
					return false;
				},
				
				pause: function(){
					alert('pause');
				},
				
				stop: function(){
					//alert('stop');
					this.model.set({'stopped': true});
					this.render();
				},
				
				restart: function(){
					//alert('stop');
					this.model.set({'stopped': false});
					this.render();
				},
				
				render: function() {
					$(this.el).html(this.template(this.model.toJSON()));
					if (this.model.get('done')) $(this.el).addClass('done'); //one directional... can't become "undone"
					return this;
				}
			});
			
			var list = new JobList;
			
			var App = Backbone.View.extend({
				el: $('#app'),
				//tagName: 'div',
				//id: 'app',
				
				initialize: function(){
					list.bind('add',	 this.add, this);
					list.bind('reset', this.addAll, this);
					//list.bind('all',	 this.render, this);
				},
				
				events: {
					"click .add":	"clicked"
				},
				
				clicked: function(e){
					console.log('clicked..');
					var names = ['Bob', 'Bill', 'Jill', 'Tom', 'Ace'];
					var rand = Math.floor(Math.random()*names.length);
					list.add({"id":this.thingid++, "status": Math.round(Math.random()*2), "title":names[rand]+" job"});
				},
				
				add: function(m){
					var view = new JobView({model: m});
					$('#manager-table', this.el).append(m, view.render().el);
				},
				
				addAll: function(e){ //gets fired after fetch()
					list.each(this.add); //attaches a view to each of the models
					//console.log(e, "reset");
				},
				
				render: function(){
					console.log("render");
				}
			});
			
			var app = new App;
			
			list.fetch(); //does an ajax request to fill up the JobList
			//list.add({{bootstrap}});
			
			/*list.add([
				{"id":0, "done": false, "name":"Bob job"},
				{"id":1, "done": false, "name":"Bill job"},
				{"id":2, "done": false, "name":"job 345"},
				{"id":3, "done": true, "name":"Jill job", "output":"infosthetics02.jpg"},
				{"id":4, "done": true, "name":"Crazy cool job", "output":"graphs.jpg"}
			]);*/
			//var view = new JobView({'model': thinger});
			//var view = new DocumentRow({'model': [thinger]});
			
			$("#manager-table").sortable();//{placeholder: "ui-state-highlight"}
			$("#manager-table").disableSelection();
			
			/*
			var uploadCallback = function(isTimeout){			
				var io = document.getElementById(frameId);
				try{				
					if(io.contentWindow){
						 xml.responseText = io.contentWindow.document.body?io.contentWindow.document.body.innerHTML:null;
						 xml.responseXML = io.contentWindow.document.XMLDocument?io.contentWindow.document.XMLDocument:io.contentWindow.document;
						 
					}else if(io.contentDocument){
						 xml.responseText = io.contentDocument.document.body?io.contentDocument.document.body.innerHTML:null;
						xml.responseXML = io.contentDocument.document.XMLDocument?io.contentDocument.document.XMLDocument:io.contentDocument.document;
					}						
				}catch(e){
					jQuery.handleError(s, xml, null, e);
				}
				if ( xml || isTimeout == "timeout"){				
					requestDone = true;
					var status;
					try {
						status = isTimeout != "timeout" ? "success" : "error";
						// Make sure that the request was successful or notmodified
						if ( status != "error" ){
							// process the data (runs the xml through httpData regardless of callback)
							var data = jQuery.uploadHttpData( xml, s.dataType );    
							// If a local callback was specified, fire it and pass it the data
							if ( s.success )
								s.success( data, status );
							// Fire the global callback
							if( s.global )
								jQuery.event.trigger( "ajaxSuccess", [xml, s] );
						} else
							jQuery.handleError(s, xml, status);
					} catch(e) {
						status = "error";
						jQuery.handleError(s, xml, status, e);
					}
					// The request was completed
					if( s.global )
						jQuery.event.trigger( "ajaxComplete", [xml, s] );
					// Handle the global AJAX counter
					if ( s.global && ! --jQuery.active )
						jQuery.event.trigger( "ajaxStop" );
					// Process result
					if ( s.complete )
						s.complete(xml, status);
					jQuery(io).unbind()
					setTimeout(function(){
						try {
							jQuery(io).remove();
							jQuery(form).remove();	
						} catch(e) {
							jQuery.handleError(s, xml, null, e);
						}									
					}, 100)
					xml = null
				}
			}
			// Timeout checker
			if ( s.timeout > 0 ) {
				setTimeout(function(){
					// Check to see if the request is still happening
					if( !requestDone ) uploadCallback( "timeout" );
				}, s.timeout);
			}
			try {
				var form = jQuery('#' + formId);
				jQuery(form).attr('action', s.url);
				jQuery(form).attr('method', 'POST');
				jQuery(form).attr('target', frameId);
				if(form.encoding){
					jQuery(form).attr('encoding', 'multipart/form-data');      			
				}else{	
					jQuery(form).attr('enctype', 'multipart/form-data');			
				}			
				jQuery(form).submit();
			} catch(e) {			
				jQuery.handleError(s, xml, null, e);
			}
			
			jQuery('#' + frameId).load(uploadCallback);
			return {abort: function () {}};	
			*/
			$('#job_upload_frame').load(function(e){
				var state = $.parseJSON(this.contentWindow.document.body.innerHTML)
				console.log('loaded', state);
			});
			$("#job_upload_form").live("submit", function(){
				//console.log($(this).serialize());
				//return false;
			});
			
		});
	</script>
{% endblock %}

{% block content %}
	<div id="app">
		<a href="#" class="add button" >Add an item</a><br>
		<div id="img"></div>
		<ul id="manager-table"></ul>
	</div>
	<br>
	<a href="/manager/upload" class="load button">Upload New Job</a>
	<iframe id="job_upload_frame" name="job_upload_frame" style="position:absolute; top:-9999px; left:-9999px;visibility:hidden;"></iframe>
	<!--<iframe id="job_upload_frame" name="job_upload_frame" style="height:250px;width:250px;position:absolute;top:0;right:0;"></iframe>-->
	<form id="job_upload_form" enctype="multipart/form-data" method="post" action="/manager/upload" target="job_upload_frame">
		<table>
		{% csrf_token %}
		{{ form }}
		</table>
		<input type="submit" value="Save" id="save_button"/>
	</form>
{% endblock %}

{% block footer %}
{% if not user.is_anonymous %}<a href="/accounts/logout/?next=/" class="exit button">Log out</a>{% endif %}
{% endblock %}
